name: Update HackerRank Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: pip install requests

      - name: Fetch HackerRank Badges
        run: |
          python - <<EOF
          import requests
          import re

          USERNAME = "joaovitor_pcost1"
          URL = f"https://www.hackerrank.com/rest/v1/profiles/{USERNAME}/badges"
          
          try:
              # Adicionando um timeout para evitar que o script trave
              response = requests.get(URL, headers={'User-Agent': 'Mozilla/5.0'}, timeout=10)
              data = response.json()
              
              badges_md = ""
              if data.get('models'):
                  for badge in data['models']:
                      name = badge['badge_name']
                      stars = badge['stars']
                      # Professional Badge format using shields.io
                      badges_md += f"![{name}](https://img.shields.io/badge/{name.replace(' ', '_')}-{stars}_Stars-2EC866?style=flat-square&logo=hackerrank) "
              
              if not badges_md:
                  badges_md = "No badges earned yet. Keep grinding! ðŸš€"
                  
          except Exception as e:
              print(f"Error fetching data: {e}")
              badges_md = "âš ï¸ HackerRank stats temporarily unavailable."

          with open("README.md", "r") as f:
              content = f.read()

          # Substitui o conteÃºdo entre as Ã¢ncoras no README
          pattern = r".*?"
          replacement = f"\n{badges_md}\n"
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)

          with open("README.md", "w") as f:
              f.write(new_content)
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || (git commit -m "Update HackerRank stats with dependencies fixed" && git push)
