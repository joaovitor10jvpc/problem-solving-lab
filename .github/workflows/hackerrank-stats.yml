name: Update HackerRank Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: pip install requests

      - name: Fetch and Inject Badges
        run: |
          python - <<EOF
          import requests
          import re
          import sys

          USERNAME = "joaovitor_pcost1"
          URL = f"https://www.hackerrank.com/rest/v1/profiles/{USERNAME}/badges"
          
          try:
              response = requests.get(URL, headers={'User-Agent': 'Mozilla/5.0'}, timeout=10)
              data = response.json()
              
              badges_md = ""
              if data.get('models'):
                  for badge in data['models']:
                      name = badge['badge_name']
                      stars = badge['stars']
                      if stars > 0:
                          badges_md += f"![{name}](https://img.shields.io/badge/{name.replace(' ', '_')}-{stars}_Stars-2EC866?style=flat-square&logo=hackerrank) "
              
              # Se n√£o houver medalhas, encerramos sem mexer no README
              if not badges_md:
                  print("No badges found. Skipping update.")
                  sys.exit(0)
                  
          except Exception as e:
              print(f"Error: {e}")
              sys.exit(0)

          with open("README.md", "r") as f:
              content = f.read()

          start_tag = ""
          end_tag = ""
          
          # Verifica se as tags existem para evitar sobrescrever o arquivo inteiro
          if start_tag in content and end_tag in content:
              pattern = rf"{start_tag}.*?{end_tag}"
              replacement = f"{start_tag}\n{badges_md}\n{end_tag}"
              new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
              
              with open("README.md", "w") as f:
                  f.write(new_content)
              print("README updated successfully.")
          else:
              print("Anchors not found. Please add the HTML comments to your README.")
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || (git commit -m "Update HackerRank badges" && git push)
